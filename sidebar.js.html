<!-- libs -->
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>

<!-- languages -->
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/dockerfile.min.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/go.min.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/lua.min.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/thrift.min.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/scala.min.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/swift.min.js"></script>
<script type="text/javascript"
        src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/languages/yaml.min.js"></script>

<script>
    // element ids
    const ID_LANGUAGE = '#language',
        ID_THEME = '#theme',
        ID_NO_BACKGROUND = '#no-background',
        ID_PREVIEW_BUTTONS = '#preview-buttons',
        ID_SHOW_PREVIEW = '#show-preview',
        ID_PREVIEW = '#preview',
        ID_PASTE = '#insert-preview',
        ID_HIGHLIGHT_BUTTONS = '#insert-buttons',
        ID_HIGHLIGHT = '#highlight-selection',
        ID_ERROR = '#error';

    const THEME_DEFAULT = 'default',
        DEFAULT_BACKGROUND_COLOR = '#f0f0f0',
        LANGUAGE_AUTO = 'Auto';

    var LANGUAGES = hljs.listLanguages();
    LANGUAGES.sort();

    /**
     * On document load, try to load languages and themes, try to load the
     * user's preferences if previously set, and assign click handlers to each button.
     */
    $(function () {
        // register jquery outerHTML plugin
        jQuery.fn.outerHTML = function () {
            return jQuery('<div />').append(this.eq(0).clone()).html();
        };

        loadLanguages();

        google.script.run
            .withFailureHandler(showErrorThemes)
            .withSuccessHandler(
                function (result, element) {
                    loadThemes(result.themes);
                    loadPreferences(result.prefs, result.themes);
                })
            .getPreferencesAndThemes();

        $(ID_HIGHLIGHT).click(highlightSelection);
        $(ID_SHOW_PREVIEW).click(showPreview);
        $(ID_PASTE).click(insertPreview);
    });

    // callback function that populates language input options
    function loadLanguages () {
        LANGUAGES.forEach(function (lang) {
            $(ID_LANGUAGE).append('<option value="' + lang + '">' + lang + '</option>');
        });
    }

    // callback function that populates theme input options
    function loadThemes (themes, prefs) {
        const themeSelect = $(ID_THEME);

        // remove 'default', because its CSS is already in HTML as a fallback
        var i = themes.indexOf(THEME_DEFAULT);
        if (i !== -1) {
            themes.splice(i, 1);
        }

        themes.forEach(function (theme) {
            themeSelect.append('<option value="' + theme + '">' + theme + '</option>');
        });
    }

    /**
     * Callback function that populates inputs elements with user preferences
     * from the server.
     *
     * @param {Object} prefs The saved preferences.
     * @param themes
     */
    function loadPreferences (prefs, themes) {
//        console.log(LANGUAGES);
//        console.log(themes);
//        console.log(prefs);

        if (prefs.language) {
            const language = $(ID_LANGUAGE);
            for (var i = 0; i < LANGUAGES.length; i++) {
                if (LANGUAGES[i] === prefs.language) {
                    language.val(prefs.language)
                }
            }
        }
        if (prefs.theme) {
            const theme = $(ID_THEME);
            for (var i = 0; i < themes.length; i++) {
                if (themes[i] === prefs.theme) {
                    theme.val(prefs.theme);
                    break;
                }
            }
        }
        if (prefs.noBackground === 'true') {
            $(ID_NO_BACKGROUND).prop('checked', true);
        }

        // enable forms
        $(ID_LANGUAGE).prop('disabled', false);
        $(ID_THEME).prop('disabled', false);
        $(ID_HIGHLIGHT).prop('disabled', false);
        $(ID_SHOW_PREVIEW).prop('disabled', false);
    }

    function replaceSpecialChars (html) {
        html = html.replace(/\u2018|\u2019|\u201A|\uFFFD/g, "'")
            .replace(/\u201c|\u201d|\u201e/g, '"')
            .replace(/\u02C6/g, '^')
            .replace(/\u2039/g, '<')
            .replace(/\u203A/g, '>')
            .replace(/\u2013/g, '-')
            .replace(/\u2014/g, '--')
            .replace(/\u2026/g, '...')
            .replace(/\u00A9/g, '(c)')
            .replace(/\u00AE/g, '(r)')
            .replace(/\u2122/g, 'TM')
            .replace(/\u00BC/g, '1/4')
            .replace(/\u00BD/g, '1/2')
            .replace(/\u00BE/g, '3/4')
            .replace(/[\u02DC|\u00A0]/g, " ");

        return html;
    }

    // button function to show code preview
    /**
     * Runs a server-side function to translate the user-selected text and update
     * the sidebar UI with the resulting translation.
     */
    function showPreview () {
        this.disabled = true;
        $(ID_ERROR).remove();

        const language = $(ID_LANGUAGE + ' option:selected').text();
        const theme = $(ID_THEME + ' option:selected').text();
        const noBackground = $(ID_NO_BACKGROUND).is(':checked');

        google.script.run
            .withFailureHandler(showErrorPreviewButtons)
            .withSuccessHandler(
                function (result, element) {
                    renderPreview(result['selection'], result['css'], language, noBackground);
                    element.disabled = false;
                })
            .withUserObject(this)
            .getSelectionAndThemeStyle(language, theme, noBackground);
    }

    // callback function render preview block
    function renderPreview (selection, css, language, noBackground) {
        const block = createHighlightedBlock(selection, css, language, noBackground);
        const preview = $(ID_PREVIEW);

        preview.replaceWith(block);
        $(ID_PASTE).prop('disabled', false);
    }

    function createHighlightedBlock (text, css, language, noBackground) {
        const preview = $(ID_PREVIEW);
        var block = preview.clone();

        text = replaceSpecialChars(text);

        block.removeClass();
        block.removeAttr('style');
        block.text(text);
        if (language !== LANGUAGE_AUTO) {
            block.addClass(language);
        }
        hljs.highlightBlock(block[0]); // todo: why [0]?

        var highlighted = block.outerHTML();
        if (css != null) {
            highlighted = juice.inlineContent(highlighted, css);
        }

        block = $($.parseHTML(highlighted));
        if (noBackground) {
            block.css('background', DEFAULT_BACKGROUND_COLOR);
        }

        return block;
    }

    // button function to highlight selection
    function highlightSelection () {
        this.disabled = true;
        $(ID_ERROR).remove();

        const language = $(ID_LANGUAGE + ' option:selected').text(),
            theme = $(ID_THEME + ' option:selected').text(),
            noBackground = $(ID_NO_BACKGROUND).is(':checked');

        google.script.run
            .withFailureHandler(showErrorHighlightButtons)
            .withSuccessHandler(
                function (result, element) {
                    const selection = result['selection'],
                        css = result['css'],
                        block = createHighlightedBlock(selection, css, language),
                        html = block.outerHTML();

                    google.script.run
                        .withFailureHandler(showErrorHighlightButtons)
                        .withSuccessHandler(focusEditor)
                        .withUserObject(element)
                        .insertCode(html, noBackground);
                })
            .withUserObject(this)
            .getSelectionAndThemeStyle(language, theme, noBackground);
    }

    // button function to insert preview
    function insertPreview () {
        this.disabled = true;
        $(ID_ERROR).remove();

        const noBackground = $(ID_NO_BACKGROUND).is(':checked');
        const html = $(ID_PREVIEW).outerHTML();

        google.script.run
            .withFailureHandler(showErrorPreviewButtons)
            .withSuccessHandler(focusEditor)
            .withUserObject(this)
            .insertCode(html, noBackground);
    }

    // success/failure callbacks
    function defaultSuccess (result, element) {
        element.disabled = false;
    }

    function focusEditor (result, element) {
        google.script.host.editor.focus();
        element.disabled = false;
    }

    function showErrorThemes (msg, element) {
        showError(msg, $('#themes'));
//        element.disabled = false;

        // enable other forms even if getting themes fails
        $(ID_LANGUAGE).prop('disabled', false);
        $(ID_THEME).prop('disabled', false);
        $(ID_HIGHLIGHT).prop('disabled', false);
        $(ID_SHOW_PREVIEW).prop('disabled', false);
    }

    function showErrorPreviewButtons (msg, element) {
        showError(msg, $(ID_PREVIEW_BUTTONS));
        element.disabled = false;
    }

    function showErrorHighlightButtons (msg, element) {
        showError(msg, $(ID_HIGHLIGHT_BUTTONS));
        element.disabled = false;
    }

    /**
     * Inserts a div that contains an error message after a given element.
     *
     * @param msg The error message to display.
     * @param element The element after which to display the error.
     */
    function showError (msg, element) {
        const div = $('<div id="error" class="error">' + msg + '</div>');
        $(element).after(div);
    }
</script>
