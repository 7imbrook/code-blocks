<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/highlight.min.js"></script>

<script>
// element ids
var ID_LANGUAGE = '#language';
var ID_THEME = '#theme';
var ID_NO_BACKGROUND = '#no-background';
var ID_PREVIEW_BUTTONS = '#preview-buttons';
var ID_SHOW_PREVIEW = '#show-preview';
var ID_PREVIEW = '#preview';
var ID_PASTE = '#insert-preview';
var ID_HIGHLIGHT_BUTTONS = '#insert-buttons';
var ID_HIGHLIGHT = '#highlight-selection';
var ID_ERROR = '#error';

var THEME_DEFAULT = 'default';
var LANGUAGES = hljs.listLanguages();

var DEFAULT_BACKGROUND_COLOR = '#f0f0f0';

/**
 * On document load, try to load languages and themes, try to load the
 * user's preferences if previously set, and assign click handlers to each button.
 */
$(function() {
  // register jquery outerHTML plugin
  jQuery.fn.outerHTML = function() {
    return jQuery('<div />').append(this.eq(0).clone()).html();
  };

  loadLanguages();

  google.script.run
      .withFailureHandler(showErrorThemes)
      .withSuccessHandler(
          function(result, element) {
            loadThemes(result.themes);
            loadPreferences(result.prefs, result.themes);
          })
      .getPreferencesAndThemes();

  $(ID_HIGHLIGHT).click(highlightSelection);
  $(ID_SHOW_PREVIEW).click(showPreview);
  $(ID_PASTE).click(insertPreview);
});

// callback function that populates language input options
function loadLanguages() {
  LANGUAGES.forEach(function(lang) {
    $(ID_LANGUAGE).append('<option value="' + lang + '">' + lang + '</option>');
  });
}

// callback function that populates theme input options
function loadThemes(themes, prefs) {
  var themeSelect = $(ID_THEME);

  // remove 'default', because its CSS is already in HTML as a fallback
  var i = themes.indexOf(THEME_DEFAULT);
  if (i != -1) {
    themes.splice(i, 1);
  } 

  for (var i = 0; i < themes.length; i++) {
    var theme = themes[i];
    themeSelect.append('<option value="' + theme + '">' + theme + '</option>');
  }
}

/**
 * Callback function that populates inputs elements with user preferences 
 * from the server.
 *
 * @param {Object} prefs The saved preferences.
 */
function loadPreferences(prefs, themes) {
//  console.log(LANGUAGES);
//  console.log(themes);
//  console.log(prefs);

  if (prefs.language) {
    var language = $(ID_LANGUAGE);
    LANGUAGES.forEach(function(lang) {
      if (lang === prefs.language) {
        language.val(prefs.language);
        return;
      }
    });
  }
  if (prefs.theme) {
    var theme = $(ID_THEME);
    for (var i = 0; i < themes.length; i++) {
      if (themes[i] === prefs.theme) {
        theme.val(prefs.theme);
        break;
      }
    }
  }
  if (prefs.noBackground === 'true') {
    $(ID_NO_BACKGROUND).prop('checked', true);
  }

  // enable forms
  $(ID_LANGUAGE).prop('disabled', false);
  $(ID_THEME).prop('disabled', false);
  $(ID_HIGHLIGHT).prop('disabled', false);
  $(ID_SHOW_PREVIEW).prop('disabled', false);
}

// todo: unused
// button function to toggle using spaces
function toggleConvertTabs() {
  var checked = $(this).is(':checked');
  hljs.configure({'tabReplace': checked ? '  ' : null});
}

// button function to show code preview
/**
 * Runs a server-side function to translate the user-selected text and update
 * the sidebar UI with the resulting translation.
 */
function showPreview() {
  this.disabled = true;
  $(ID_ERROR).remove();

  var language = $(ID_LANGUAGE + ' option:selected').text();
  var theme = $(ID_THEME + ' option:selected').text();
  var noBackground = $(ID_NO_BACKGROUND).is(':checked');

  google.script.run
      .withFailureHandler(showErrorPreviewButtons)
      .withSuccessHandler(
          function(result, element) {
            var selection = result['selection'];
            var css = result['css'];
            renderPreview(selection, css, language, noBackground);

            element.disabled = false;
          })
      .withUserObject(this)
      .getSelectionAndThemeStyle(language, theme, noBackground);
}

// callback function render preview block
function renderPreview(selection, css, language, noBackground) {
  var highlighted = createHighlightedBlock(selection, css, language, noBackground);
  $(ID_PREVIEW).replaceWith(highlighted);

  $(ID_PASTE).prop('disabled', false);
}

function createHighlightedBlock(text, css, language, noBackground) {
  var preview = $(ID_PREVIEW);
  var block = preview.clone();

  block.removeClass();
  block.removeAttr('style');
  block.text(text);
  if (language !== 'Auto') { // todo: to constant
    block.addClass(language);
  }
  hljs.highlightBlock(block[0]); // todo: why [0]?

  var highlighted = block.outerHTML();
  if (css != null) {
    highlighted = juice.inlineContent(highlighted, css);
  }
  
  if (noBackground) {
    resetBackground(highlighted);
  }
  
  return highlighted;
}

/*
// button function to clear preview
function clearCode() {
  this.disabled = true;
  $('error').remove()
  google.script.run
      .withFailureHandler(showErrorPreviewButtons)
      .withSuccessHandler(
          function(result, element) {
            var preview = $(ID_PREVIEW);
            preview.empty();
            resetBackground(preview);
            $('#insert-code').prop('disabled', true);
          }
      )
      .withUserObject(this)
      .stub();
}
*/

// button function to highlight selection
function highlightSelection() {
  this.disabled = true;
  $(ID_ERROR).remove();

  var preview = $(ID_PREVIEW);
  var language = $(ID_LANGUAGE + ' option:selected').text();
  var theme = $(ID_THEME + ' option:selected').text();
  var noBackground = $(ID_NO_BACKGROUND).is(':checked');

  google.script.run
      .withFailureHandler(showErrorHighlightButtons)
      .withSuccessHandler(
          function(result, element) {
            var selection = result['selection'];
            var css = result['css'];
            var block = createHighlightedBlock(selection, css, language, noBackground);

            google.script.run
                .withFailureHandler(showErrorHighlightButtons)
                .withSuccessHandler(focusEditor)
                .withUserObject(element)
                .insertCode(block, noBackground);
          })
      .withUserObject(this)
      .getSelectionAndThemeStyle(language, theme, noBackground);
}

// button function to insert preview
function insertPreview() {
  this.disabled = true;
  $(ID_ERROR).remove();

  var noBackground = $(ID_NO_BACKGROUND).is(':checked');
  var html = $(ID_PREVIEW).outerHTML();

  google.script.run
      .withFailureHandler(showErrorHighlightButtons)
      .withSuccessHandler(focusEditor)
      .withUserObject(this)
      .insertCode(html, noBackground);
}

// success/failure callbacks
function defaultSuccess(result, element) {
  element.disabled = false;
}

function focusEditor(result, element) {
  google.script.host.editor.focus();
  element.disabled = false;
}

function showErrorThemes(msg, element) {
  showError(msg, $('#themes'));
//  element.disabled = false;

  // enable other forms even if getting themes fails
  $(ID_LANGUAGE).prop('disabled', false);
  $(ID_THEME).prop('disabled', false);
  $(ID_HIGHLIGHT).prop('disabled', false);
  $(ID_SHOW_PREVIEW).prop('disabled', false);
}

function showErrorPreviewButtons(msg, element) {
  showError(msg, $(ID_PREVIEW_BUTTONS));
  element.disabled = false;
}

function showErrorHighlightButtons(msg, element) {
  showError(msg, $(ID_HIGHLIGHT_BUTTONS));
  element.disabled = false;
}

function resetBackground(element) {
  element.css('background', DEFAULT_BACKGROUND_COLOR);
}

/**
 * Inserts a div that contains an error message after a given element.
 *
 * @param msg The error message to display.
 * @param element The element after which to display the error.
 */
function showError(msg, element) {
  var div = $('<div id="error" class="error">' + msg + '</div>');
  $(element).after(div);
}
</script>
